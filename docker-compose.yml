# ATHENA — Full stack: FastAPI + Next.js + Nginx
# Quick start:
#   cp backend/.env.example backend/.env
#   docker compose up --build
#
# Access:
#   http://localhost       → ATHENA UI (via nginx)
#   http://localhost/api/v1/health  → API health
#   http://localhost/docs  → Swagger UI

services:

  # ─────────────────────────────────────────────
  # FastAPI backend
  # ─────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: athena-backend
    restart: unless-stopped
    env_file: ./backend/.env
    environment:
      # Override stub mode: set to "true" to use Deploy.AI agents
      STUB_MODE: ${STUB_MODE:-true}
      LATS_ENABLED: ${LATS_ENABLED:-true}
      LOG_DIR: /app/logs
    volumes:
      - reports_data:/app/reports
      - logs_data:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    expose:
      - "8000"
    networks:
      - athena_net

  # ─────────────────────────────────────────────
  # Next.js frontend
  # ─────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: athena-frontend
    restart: unless-stopped
    environment:
      # Points to nginx so all traffic flows through the proxy
      NEXT_PUBLIC_API_URL: http://localhost/api/v1
      NODE_ENV: production
    depends_on:
      backend:
        condition: service_healthy
    expose:
      - "3000"
    networks:
      - athena_net

  # ─────────────────────────────────────────────
  # Nginx reverse proxy (public entry point)
  # ─────────────────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: athena-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost/nginx-health"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - athena_net

volumes:
  reports_data:
  logs_data:

networks:
  athena_net:
    driver: bridge
